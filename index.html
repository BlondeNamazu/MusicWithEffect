<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
</head>
<body>
  <input type="text" id="msg_input" style="width:200px;" />
  <button onclick="publishMessage();">語る</button>
  <button id="playbutton" onclick="playMusic();">Play</button>
  <div>
  <audio id="audio1" src="clock.mp3" preload="auto" style="width:25%" controls loop>Canvas not supported</audio>
  </div>
  <div>
  <input type="range" min="0" max="100" value="100" onchange="changeVolume(this.value);" />
  </div>
  <!--<div>
  <input type="text" id="audioFile" value="./clock.mp3" size="60" />
  </div>-->
  <div id="msg"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    // 1.イベントとコールバックの定義
    //var socketio = io.connect('http://localhost:8080');
    var socketio = io.connect();
    
    //values
    var gx=0;
    var gy=0;
    var gz=0;
    var light=0;
    var ax=0;
    var ay=0;
    var az=0;
    
    var audioElm = new Audio("./clock.mp3");
    
    function togglePlay(){
        if(audioElm.paused == true){
            playAudio(audioElm);
        } else {
          pauseAudio(audioElm);
        }
    }
    
    function playAudio(audioElm){
      document.getElementById("playbutton").innerHTML="Pause";
      //audioElm.src = document.getElementById('audioFile').value;
      
      audioElm.play();
      //document.querySelector('#audioFile').play();
    }
    
    function pauseAudio(audioElm){
      document.getElementById("playbutton").innerHTML="Play";
      audioElm.pause();
    }

    socketio.on("publish", function (data) { addMessage(data.value); });
    
    var context;
    var bufferLoader;
    var sourceClock,sourceAudio;
    var gainNode;
    
    function init(){
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();
      bufferLoader = new BufferLoader(
        context,
        [
          './clock.mp3',
          './audio.mp3'
        ],
        finishedLoading
      );
      bufferLoader.load();
    }
    
    function finishedLoading(bufferList){
      console.log("finished Loading!");
      sourceClock = context.createBufferSource();
      sourceAudio = context.createBufferSource();
      sourceClock.buffer = bufferList[0];
      sourceAudio.buffer = bufferList[1];
      
      //sourceClock.connect(context.destination);
      sourceAudio.connect(context.destination);
      
      gainNode = context.createGain();
      sourceClock.connect(gainNode);
      gainNode.connect(context.destination);
      
      sourceClock.loop = true;
      
      sourceClock.start(0);
    }
    
    function BufferLoader(context, urlList, callback) {
      this.context = context;
      this.urlList = urlList;
      this.onload = callback;
      this.bufferList = new Array();
      this.loadCount = 0;
    }

    BufferLoader.prototype.loadBuffer = function(url, index) {
      // Load buffer asynchronously
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
      request.responseType = "arraybuffer";

      var loader = this;

      request.onload = function() {
        // Asynchronously decode the audio file data in request.response
        loader.context.decodeAudioData(
          request.response,
          function(buffer) {
            if (!buffer) {
              alert('error decoding file data: ' + url);
              return;
            }
            loader.bufferList[index] = buffer;
            if (++loader.loadCount == loader.urlList.length)
              loader.onload(loader.bufferList);
          },
          function(error) {
            console.error('decodeAudioData error', error);
          }
        );
      }

      request.onerror = function() {
        alert('BufferLoader: XHR error');
      }

      request.send();
    }

    BufferLoader.prototype.load = function() {
      for (var i = 0; i < this.urlList.length; ++i)
      this.loadBuffer(this.urlList[i], i);
    }
    
    function changeVolume (val){
      gainNode.gain.value = val * val /10000;
    }
    
    function playMusic (){
      // var source = sourceClock;
      // if(!source.start) source.start = source.noteOn;
      // source.start(0);
      sourceClock.start();
    }

    // 2.イベントに絡ませる関数の定義
    function start(name) {
      init();
      socketio.emit("connected", name);
    }

    function publishMessage() {
      var textInput = document.getElementById('msg_input');
      var msg = "[" + myName + "] " + textInput.value;
      socketio.emit("publish", {value: msg});
      textInput.value = '';
    }
    
    function addDebugMsg(val){
      console.log(val);
    }

    function addMessage (msg) {
      clearMsgArea();
      parse(msg);
      addMsgChild("gx = ",gx);
      addMsgChild("gy = ",gy);
      addMsgChild("gz = ",gz);
      addMsgChild("light = ",light);
      addMsgChild("ax = ",ax);
      addMsgChild("ay = ",ay);
      addMsgChild("az = ",az);
      //msgArea.insertBefore(domMeg,msgArea.firstChild)
    }
    
    function addMsgChild(des,val){
      var str = des + val;
      var domMeg = document.createElement('div');
      domMeg.innerHTML = new Date().toLocaleTimeString() + ' ' + str;
      msgArea.appendChild(domMeg);
    }
    
    function clearMsgArea(){
      while(msgArea.firstChild) msgArea.removeChild(msgArea.firstChild);
    }
    
    function parse(data){
      data = data.split(" ");
      if(data[1] == null) return;
      if(data[1] == "gx"){
        gx = data[2];
      } else if(data[1] == "gy"){
        gy = data[2];
      } else if(data[1] == "gz"){
        gz = data[2];
      } else if(data[1] == "light"){
        light = data[2];
      } else if(data[1] == "ax"){
        ax = data[2];
      } else if(data[1] == "ay"){
        ay = data[2];
      } else if(data[1] == "az"){
        az = data[2];
      } 
    }

    // 3.開始処理
    var msgArea = document.getElementById("msg");
    var myName = Math.floor(Math.random()*100) + "さん";
    addMessage("貴方は" + myName + "として入室しました");
    start(myName);
  </script>
</body>
</html>