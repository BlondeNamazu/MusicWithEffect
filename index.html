<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Music with Effect</title>
</head>
<body>
  <!--<input type="text" id="msg_input" style="width:200px;" />
  <button onclick="publishMessage();">語る</button>
  <button id="playbutton" onclick="playMusic();">Play</button>-->
  <!--<div>
  <audio id="audio1" src="clock.mp3" preload="auto" style="width:25%" controls loop>Canvas not supported</audio>
  </div>
  <div>
  <input type="range" min="0" max="100" value="100" onchange="changeVolume(this.value);" />
  </div>-->
  <!--<div>
  <input type="text" id="audioFile" value="./clock.mp3" size="60" />
  </div>-->
  <!--<div id="msg"></div>-->
  <canvas id="canvas" width="1000" height="1000"></canvas>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    // 1.イベントとコールバックの定義
    //var socketio = io.connect('http://localhost:8080');
    var socketio = io.connect();
    
    var ctx;
    var canvas;
    
    //gravity values
    var gx=0;
    var gy=0;
    var gz=0;
    
    //light values
    var light=0;
    
    //acceleration values
    var ax=0;
    var ay=0;
    var az=0;
    
    //color component
    var cr=255;
    var cg=255;
    var cb=255;
    
    //ballPosition
    var ballX = 0;
    var ballY = 0;
    
    //ballRange
    var ballR = 0;
    
    var alpha = 0.9;
    
    var loadFinished = false;
    var nowPlaying = false;
    
    socketio.on("publish", function (data) { addMessage(data.value); });
    
    var context;
    var bufferLoader;
    var sourceClock//,sourceAudio;
    var gainNode,distortion,bFilter,convolver,synth,pan;
    var bufferClock,bufferAudio;
    var isDelayValid = false;
    var isDistortionValid = false;
    var distortionFlagTimer = 0;
    
    function init(){
      canvas = document.getElementById("canvas");
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      canvas.width = window.innerWidth * window.devicePixelRatio;
      canvas.height = window.innerHeight * window.devicePixelRatio;
      ctx = canvas.getContext("2d");
      canvas.addEventListener('click',onClick);
      
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      context = new AudioContext();
      bufferLoader = new BufferLoader(
        context,
        [
          './zense.mp3'
          // './clock.mp3'
          // './audio.mp3'
        ],
        finishedLoading
      );
      bufferLoader.load();
    }
    
    function finishedLoading(bufferList){
      console.log("finished Loading!");
      bufferClock = bufferList[0];
      //bufferAudio = bufferList[0];
      
      loadFinished = true;
    }
    
    function BufferLoader(context, urlList, callback) {
      this.context = context;
      this.urlList = urlList;
      this.onload = callback;
      this.bufferList = new Array();
      this.loadCount = 0;
    }

    BufferLoader.prototype.loadBuffer = function(url, index) {
      // Load buffer asynchronously
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
      request.responseType = "arraybuffer";

      var loader = this;

      request.onload = function() {
        // Asynchronously decode the audio file data in request.response
        loader.context.decodeAudioData(
          request.response,
          function(buffer) {
            if (!buffer) {
              alert('error decoding file data: ' + url);
              return;
            }
            loader.bufferList[index] = buffer;
            if (++loader.loadCount == loader.urlList.length)
              loader.onload(loader.bufferList);
          },
          function(error) {
            console.error('decodeAudioData error', error);
          }
        );
      }

      request.onerror = function() {
        alert('BufferLoader: XHR error');
      }

      request.send();
    }

    BufferLoader.prototype.load = function() {
      for (var i = 0; i < this.urlList.length; ++i)
      this.loadBuffer(this.urlList[i], i);
    }
    
    function changeVolume (val){
      if(val>1) val /= 10000;
      gainNode.gain.value = val;
    }
    
    function makeDistortionCurve(amount) {
      var k = typeof amount === 'number' ? amount : 50,
        n_samples = 44100,
        curve = new Float32Array(n_samples),
        deg = Math.PI / 180,
        i = 0,
        x;
      for ( ; i < n_samples; ++i ) {
        x = i * 2 / n_samples - 1;
        curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
      }
      //return curve;
      distortion.curve = curve;
      distortion.oversample = '4x';
    };
    
    function setBFilter (value){
      bFilter.type = "lowshelf";
      bFilter.frequency.value = 1000;
      bFilter.gain.value = value;
    }
    
    function setDelay(value){
      synth.delayTime.value = value;
    }
        
    function playMusic (){
      if(!loadFinished){
        console.log("Please wait");
        return;
      }
      if(!nowPlaying){
        sourceClock = context.createBufferSource();
        //sourceAudio = context.createBufferSource();
        sourceClock.buffer = bufferClock;
        //sourceAudio.buffer = bufferAudio;
        
        //sourceClock.connect(context.destination);
        //sourceAudio.connect(context.destination);
        
        gainNode = context.createGain();
        distortion = context.createWaveShaper();
        bFilter = context.createBiquadFilter();
        convolver = context.createConvolver();
        synth = context.createDelay(5.0);
        pan = context.createStereoPanner();
        
        sourceClock.connect(distortion);
        distortion.connect(bFilter);
        bFilter.connect(synth);
        synth.connect(gainNode);
        gainNode.connect(pan);
        pan.connect(context.destination)
        
        bFilter.gain.value = 0;
        
        
        
        sourceClock.loop = true;
        sourceClock.start(0);
        nowPlaying = true;
      } else {
        sourceClock.stop(0);
        nowPlaying = false;
      }
    }

    // 2.イベントに絡ませる関数の定義
    function start(name) {
      init();
      socketio.emit("connected", name);
      setInterval(drawCanvas,8);
    }

    function publishMessage() {
      var textInput = document.getElementById('msg_input');
      var msg = "[" + myName + "] " + textInput.value;
      socketio.emit("publish", {value: msg});
      textInput.value = '';
    }
    
    function addDebugMsg(val){
      console.log(val);
    }

    function addMessage (msg) {
      //clearMsgArea();
      parse(msg);
      // addMsgChild("gx = ",gx);
      // addMsgChild("gy = ",gy);
      // addMsgChild("gz = ",gz);
      // addMsgChild("light = ",light);
      // addMsgChild("ax = ",ax);
      // addMsgChild("ay = ",ay);
      // addMsgChild("az = ",az);
      //msgArea.insertBefore(domMeg,msgArea.firstChild)
    }
    
    function addMsgChild(des,val){
      var str = des + val;
      var domMeg = document.createElement('div');
      domMeg.innerHTML = new Date().toLocaleTimeString() + ' ' + str;
      msgArea.appendChild(domMeg);
    }
    
    function clearMsgArea(){
      while(msgArea.firstChild) msgArea.removeChild(msgArea.firstChild);
    }
    
    function onClick(e){
      playMusic();
    }
    function drawCanvas(){
      if(!loadFinished) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle= 'rgb('+Math.floor((25*gx+255)/2)+','+Math.floor((25*gy+255)/2)+','+Math.floor((25*gz+255)/2)+')';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.font= 'bold 40px Century Gothic';
      ctx.strokeStyle = "white";
      ctx.textAlign = 'center';
      ctx.testBaseline = 'middle';
      ctx.strokeText("Music",canvas.width/2,canvas.height*2/5);
      ctx.strokeText("Effect",canvas.width/2,canvas.height*3/5);
      ctx.fillStyle= 'rgb('+Math.floor((-25*gy+255)/2)+','+Math.floor((-25*gz+255)/2)+','+Math.floor((-25*gx+255)/2)+')';
      ctx.fillText("Music",canvas.width/2,canvas.height*2/5);
      ctx.fillText("Effect",canvas.width/2,canvas.height*3/5);
      ctx.font= 'bold 20px Century Gothic';
      ctx.strokeText("with",canvas.width/2,canvas.height/2);
      ctx.fillText("with",canvas.width/2,canvas.height/2);
      // ctx.beginPath();
      // ctx.arc(canvas.width*ballX,canvas.height*ballY,ballR,0,Math.PI*2,true);
      // ctx.closePath();
      // ctx.fill();
    }
    
    function parse(data){
      data = data.split(" ");
      if(data[1] == null) return;
      if(data[1] == "gx"){
        gx = data[2];
        cR=25*gx;
        ballY = ballY*alpha+(1-alpha)*(0.5+gx/20.0);
        if(nowPlaying)setBFilter(gx*3.5);
      } else if(data[1] == "gy"){
        gy = data[2];
        cG=25*gy;
        ballX = ballX*alpha+(1-alpha)*(0.5+gy/20.0);
        if(nowPlaying)pan.pan.value = gy / 10.0;
      } else if(data[1] == "gz"){
        gz = data[2];
        cB=25*gz;
        if(nowPlaying)setDelay(Math.pow(10-gz,4)/80000);
      } else if(data[1] == "light"){
        light = data[2];
      } else if(data[1] == "ax"){
        ax = data[2];
      } else if(data[1] == "ay"){
        ay = data[2];
      } else if(data[1] == "az"){
        az = data[2];
      } 
      var aSize = Math.sqrt(ax*ax+ay*ay+az*az);
      ballR = Math.max(150,aSize*12);
    }

    // 3.開始処理
    var msgArea = document.getElementById("msg");
    var myName = Math.floor(Math.random()*100) + "さん";
    addMessage("貴方は" + myName + "として入室しました");
    start(myName);
  </script>
</body>
</html>